<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Habit tracker</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 500px;
    margin: 2em auto;
    padding: 1em;
    background: #f9f9f9;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  #habit-form {
    display: flex;
    margin-bottom: 1em;
  }
  #habit-name {
    flex: 1;
    padding: 0.5em;
    font-size: 1em;
    border: 1px solid #ccc;
    border-radius: 4px 0 0 4px;
    outline: none;
  }
  #habit-name:focus {
    border-color: #007bff;
  }
  #add-btn {
    padding: 0.5em 1em;
    margin-left: 0;
    font-size: 1em;
    cursor: pointer;
    border: 1px solid #007bff;
    background: #007bff;
    color: white;
    border-radius: 0 4px 4px 0;
    transition: background 0.3s;
  }
  #add-btn:hover {
    background: #0056b3;
  }
  ul {
    list-style: none;
    padding: 0;
  }
  li {
    background: transparent;
    margin-bottom: 0.5em;
    padding: 0.7em 1em;
    display: flex;
    align-items: center;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: grab;
  }
  li:active {
    cursor: grabbing;
  }
  li input[type="checkbox"] {
    margin-right: 1em;
    transform: scale(1.3);
    cursor: pointer;
  }
  .habit-text {
    flex: 1;
    user-select: none;
  }
  .delete-btn {
    background: transparent;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    font-size: 1.3em;
    line-height: 1;
    cursor: pointer;
    padding: 0 0.3em;
    user-select: none;
  }
  .delete-btn:hover {
    color: #c0392b;
  }
</style>
</head>
<body>

<h1>Habit tracker</h1>

<form id="habit-form">
  <input type="text" id="habit-name" placeholder="Add new habit" required autocomplete="off" />
  <button type="submit" id="add-btn">Add</button>
</form>

<ul id="habit-list"></ul>

<script>
  const form = document.getElementById('habit-form');
  const input = document.getElementById('habit-name');
  const habitList = document.getElementById('habit-list');

  const STORAGE_KEY = 'dailyHabits';

  function getToday() {
    const d = new Date();
    return d.toISOString().slice(0,10);
  }

  function loadHabits() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return [];
    try {
      const obj = JSON.parse(data);
      if (obj.date !== getToday()) {
        obj.habits.forEach(h => h.done = false);
        obj.date = getToday();
        saveHabits(obj);
      }
      return obj.habits;
    } catch {
      return [];
    }
  }

  function saveHabits(obj) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }

  function updateStorage(habits) {
    saveHabits({date: getToday(), habits});
  }

  let habits = loadHabits();

  function renderHabits() {
    habitList.innerHTML = '';
    habits.forEach(habit => {
      const li = document.createElement('li');
      li.setAttribute('draggable', 'true');
      li.dataset.id = habit.id;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = habit.done;
      checkbox.addEventListener('change', () => {
        habit.done = checkbox.checked;
        updateStorage(habits);
      });

      const span = document.createElement('span');
      span.textContent = habit.text;
      span.className = 'habit-text';

      const delBtn = document.createElement('button');
      delBtn.textContent = '×';
      delBtn.className = 'delete-btn';
      delBtn.addEventListener('click', () => {
        habits = habits.filter(h => h.id !== habit.id);
        updateStorage(habits);
        renderHabits();
      });

      li.appendChild(checkbox);
      li.appendChild(span);
      li.appendChild(delBtn);
      habitList.appendChild(li);
    });

    addDragAndDrop();
  }

  // ドラッグ＆ドロップの処理
  function addDragAndDrop() {
    let dragSrcEl = null;

    function handleDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.style.opacity = '0.5';
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter() {
      this.classList.add('over');
    }

    function handleDragLeave() {
      this.classList.remove('over');
    }

    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      if (dragSrcEl !== this) {
        // 並べ替え
        const fromId = dragSrcEl.dataset.id;
        const toId = this.dataset.id;
        const fromIndex = habits.findIndex(h => h.id == fromId);
        const toIndex = habits.findIndex(h => h.id == toId);
        habits.splice(toIndex, 0, habits.splice(fromIndex, 1)[0]);
        updateStorage(habits);
        renderHabits();
      }
      return false;
    }

    function handleDragEnd() {
      this.style.opacity = '1';
      habitList.querySelectorAll('li').forEach(li => {
        li.classList.remove('over');
      });
    }

    const items = habitList.querySelectorAll('li');
    items.forEach(item => {
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragenter', handleDragEnter);
      item.addEventListener('dragover', handleDragOver);
      item.addEventListener('dragleave', handleDragLeave);
      item.addEventListener('drop', handleDrop);
      item.addEventListener('dragend', handleDragEnd);
    });
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    const newHabit = {id: Date.now() + Math.random(), text, done: false};
    habits.push(newHabit);
    updateStorage(habits);
    renderHabits();
    input.value = '';
  });

  renderHabits();
</script>

</body>
</html>
